<template>
    <div class="rightbar" :style="rightTabshow?'right:0;':'right:-250px;'" @click="cancelAll">
        <div class="rightbar-wrap">
            <div class="rightbar-top">
                <p>角色列表</p>
                <div class="outerContainer tree-container">
                    <el-tree
                            ref="tree"
                            :data="treeData"
                            :props="treeOption"
                            :load="loadNode"
                            lazy
                            node-key="id"
                            :expand-on-click-node="false"
                            :default-expanded-keys="treeExpandedArr"
                            icon-class="el-icon-arrow-right"
                            :indent="19"
                            highlight-current
                            @node-contextmenu="rightClick"
                            @node-click="toEquipment"
                            :empty-text="treeStatus?'正在加载...':'暂无数据'"
                    >
          <span class="custom-tree-node" slot-scope="{ node ,data}">
              <img src="../../assets/image/building.png" style="height:16px;width:16px;transform:translateY(-2px);">
              <span v-if="data.rolename">
                &nbsp;{{data.rolename}}
              </span>
              <span v-else>
                <el-input
                        v-model="rolename"
                        class="tree-input"
                        @keyup.enter.native="addSubmit(data)"
                        @keyup.esc.native="cancelInput"
                        :maxlength="8"
                        placeholder="限制输入8个字"
                        clearable
                        autofocus
                ></el-input>
                <i
                        class="el-icon-circle-check-outline"
                        style="font-size:14px;"
                        @click="addSubmit(data)"
                ></i>
                <i
                        class="el-icon-circle-close-outline"
                        style="font-size:14px;"
                        @click="cancelInput"
                ></i>
              </span>
          </span>
                    </el-tree>
                </div>
                <!-- 鼠标右键菜单栏 -->
                <div v-show="menuVisible">
                    <ul class="menu" ref="menu">
                        <li class="menu__item" @click="dialogEnterprise=true,getEnterpriseList()"><i class="el-icon-document"></i> 查看档案</li>
                        <li class="menu__item" @click="treeData=[],getList()"><i class="el-icon-refresh"></i>刷新</li>
                        <li class="menu__item" @click="onAdd"><i class="el-icon-circle-plus-outline"></i>添加</li>
                        <li class="menu__item" @click="onDelete"><i class="el-icon-circle-close-outline"></i>删除</li>
                    </ul>
                </div>
            </div>
            <div class="rightbar-bottom">
                <div class="rightbar-bottom-title">
                    <span>用户列表</span>
                    <div @click="dialogVisible=true">
                        <i class="el-icon-plus" style="color:#2df5c7;"></i>
                        <span>添加用户</span>
                    </div>
                </div>
                <!-- <p>用户列表</p> -->
                <div class="outerContainer tree-container">
                    <el-tree
                            ref="usersTree"
                            :data="usersData"
                            node-key="id"
                            :indent="0"
                            :props="treeUsersOption"
                            icon-class="el-icon-arrow-right"
                            @node-contextmenu="usersRightClick"
                            :empty-text="usersStatus?'正在加载...':'暂无数据'"
                    >
          <span class="custom-tree-node" slot-scope="{ node}">
            <span>
              <img src="../../assets/image/user.png" style="height:16px;width:16px;transform:translateY(-2px);">
              &nbsp;{{node.label}}
            </span>
          </span>
                    </el-tree>
                </div>
                <!-- 鼠标右键菜单栏 -->
                <div v-show="usersMenuVisible">
                    <ul class="menu" ref="usersMenu">
                        <li class="menu__item" @click="usersData=[],getUsersList(currentdata.id)"><i class="el-icon-refresh"></i>刷新</li>
                        <li class="menu__item" @click="userDelete"><i class="el-icon-circle-close-outline"></i>删除</li>
                        <li class="menu__item" @click="initPassword"><i class="el-icon-circle-close-outline"></i>初始化密码</li>
                    </ul>
                </div>
            </div>
            <!-- 展开收缩右边边栏 -->
            <div class="right-toggle" @click="rightTabshow = !rightTabshow"></div>
        </div>
        <!-- 查看档案弹窗 -->
        <el-dialog
                class="dialogEnterprise"
                title="查看档案"
                :visible.sync="dialogEnterprise"
                @close="dialogEnterpriseClose">
            <el-card class="enterprise">
                <div slot="header" class="clearfix">
                    <span>{{enterprise.enterprisename}}</span>
                    <el-button
                            style="float: right; padding: 6px 8px 0 0"
                            type="text"
                            @click="modifyEnterpriseBtn"
                    >修改</el-button>
                </div>
                <div>
                    <p>
                        <span>企业联系人姓名：{{enterprise.enterprisecontactname}}</span>
                        <span>企业联系人号码：{{enterprise.enterprisecontactphone}}</span>
                    </p>
                    <p>
                        <span>统一社会信用代码：{{enterprise.unifiedsocialcreditcode}}</span>
                        <span>条目创建日期：{{enterprise.createdate}}</span>
                    </p>
                    <p>地址：{{enterprise.address}}</p>
                    <p>企业概述：{{enterprise.enterpriseoverview}}</p>
                </div>
            </el-card>
            <el-card class="engineerChecksStatusReport">
                <div slot="header" class="clearfix">
                    <span>工程师检查情况报告</span>
                    <div style="float:right;">
                        <el-upload
                                ref="upload1"
                                style="display:inline-block;"
                                action="/api/pc/examReport/addEngineer"
                                :multiple="false"
                                accept="image/jpeg,image/png,image/jpg,application/pdf"
                                :data="{'enterpriseid':enterprise.id}"
                                :show-file-list="false"
                                :auto-upload="false"
                                :on-change="uploadChange"
                                :on-success="uploadSuccess"
                                :on-error="uploadError"
                        >
                            <el-button size="small" type="text">新增</el-button>
                        </el-upload>
                        <el-button type="text" size="small" @click="deleteReport(1)">删除</el-button>
                    </div>
                </div>
                <el-table
                        :data="engineerChecksStatusReport"
                        @selection-change="handleSelectionChange1"
                        style="width: 100%">
                    <el-table-column
                            type="selection"
                            width="30">
                    </el-table-column>
                    <el-table-column
                            type="index"
                            label="序号"
                            width="50">
                    </el-table-column>
                    <el-table-column
                            prop="id"
                            label="报告ID"
                            width="200">
                    </el-table-column>
                    <el-table-column
                            prop="createdate"
                            label="创建日期"
                            width="200">
                    </el-table-column>
                    <!-- <el-table-column
                      prop="contentpic"
                      label="文件路径">
                    </el-table-column> -->
                    <el-table-column
                            label="操作">
                        <template slot-scope="scope">
                            <el-button type="text" size="small" @click="dialogfileView=true,dialogImageUrl='http://47.97.109.22'+scope.row.contentpic">查看</el-button>
                            <el-upload
                                    ref="upload2"
                                    style="display:inline-block;"
                                    action="/api/pc/examReport/update"
                                    accept="image/jpeg,image/png,image/jpg,application/pdf"
                                    :multiple="false"
                                    :data="{'id':scope.row.id,'version':scope.row.version}"
                                    :show-file-list="false"
                                    :auto-upload="false"
                                    :on-change="uploadChange"
                                    :on-success="uploadSuccess"
                                    :on-error="uploadError"
                            >
                                <el-button type="text" size="small">修改</el-button>
                            </el-upload>
                        </template>
                    </el-table-column>
                </el-table>
                <el-pagination
                        small
                        @current-change="handleCurrentChange1"
                        :current-page.sync="pageData.currentPage1"
                        layout="prev, pager, next"
                        :page-size="5"
                        :total="pageData.total1">
                </el-pagination>
            </el-card>
            <el-card class="reportElectricalEliminationTest">
                <div slot="header" class="clearfix">
                    <span>电消检测报告管理</span>
                    <div style="float:right;">
                        <el-upload
                                style="display:inline-block;"
                                action="/api/pc/examReport/addElectric"
                                :multiple="false"
                                :data="{'enterpriseid':enterprise.id}"
                                :show-file-list="false"
                                ref="upload3"
                                :auto-upload="false"
                                :on-change="uploadChange"
                                :on-success="uploadSuccess"
                                :on-error="uploadError"
                                accept="image/jpeg,image/png,image/jpg,application/pdf"
                        >
                            <el-button size="small" type="text">新增</el-button>
                        </el-upload>
                        <el-button type="text" size="small" @click="deleteReport(2)">删除</el-button>
                    </div>
                </div>
                <el-table
                        :data="reportElectricalEliminationTest"
                        @selection-change="handleSelectionChange2"
                        style="width: 100%">
                    <el-table-column
                            type="selection"
                            width="30">
                    </el-table-column>
                    <el-table-column
                            type="index"
                            label="序号"
                            width="50">
                    </el-table-column>
                    <el-table-column
                            prop="id"
                            label="报告ID"
                            width="200">
                    </el-table-column>
                    <el-table-column
                            prop="createdate"
                            label="报告日期"
                            width="200">
                    </el-table-column>
                    <!-- <el-table-column
                      prop="contentpic"
                      label="文件路径">
                    </el-table-column> -->
                    <el-table-column
                            label="操作">
                        <template slot-scope="scope">
                            <el-button type="text" size="small" @click="dialogfileView=true,dialogImageUrl='http://47.97.109.22/'+scope.row.contentpic">查看</el-button>
                            <el-upload
                                    ref="upload4"
                                    style="display:inline-block;"
                                    action="/api/pc/examReport/update"
                                    :multiple="false"
                                    :data="{'id':scope.row.id,'version':scope.row.version}"
                                    :auto-upload="false"
                                    :show-file-list="false"
                                    :on-change="uploadChange"
                                    accept="image/jpeg,image/png,image/jpg,application/pdf"
                                    :on-success="uploadSuccess"
                                    :on-error="uploadError"
                            >
                                <el-button type="text" size="small">修改</el-button>
                            </el-upload>
                        </template>
                    </el-table-column>
                </el-table>
                <el-pagination
                        small
                        :page-size="5"
                        @current-change="handleCurrentChange2"
                        :current-page.sync="pageData.currentPage2"
                        layout="prev, pager, next"
                        :total="pageData.total2">
                </el-pagination>
            </el-card>
            <el-card class="riskAssessmentReport">
                <div slot="header" class="clearfix">
                    <span>风险评估报告</span>
                    <div style="float:right;">
                        <el-upload
                                style="display:inline-block;"
                                action="/api/pc/examReport/addRisk"
                                :multiple="false"
                                :data="{'enterpriseid':enterprise.id}"
                                :show-file-list="false"
                                ref="upload5"
                                :auto-upload="false"
                                :on-change="uploadChange"
                                :on-success="uploadSuccess"
                                :on-error="uploadError"
                                accept="image/jpeg,image/png,image/jpg,application/pdf"
                        >
                            <el-button size="small" type="text">新增</el-button>
                        </el-upload>
                        <el-button type="text" size="small" @click="deleteReport(3)">删除</el-button>
                    </div>
                </div>
                <el-table
                        :data="riskAssessmentReport"
                        @selection-change="handleSelectionChange3"
                        style="width: 100%">
                    <el-table-column
                            type="selection"
                            width="30">
                    </el-table-column>
                    <el-table-column
                            type="index"
                            label="序号"
                            width="50">
                    </el-table-column>
                    <el-table-column
                            prop="id"
                            label="报告ID"
                            width="200">
                    </el-table-column>
                    <el-table-column
                            prop="createdate"
                            label="创建日期"
                            width="200">
                    </el-table-column>
                    <!-- <el-table-column
                      prop="contentpic"
                      label="文件路径">
                    </el-table-column> -->
                    <el-table-column
                            label="操作">
                        <template slot-scope="scope">
                            <el-button type="text" size="small" @click="dialogfileView=true,dialogImageUrl='http://47.97.109.22/'+scope.row.contentpic">查看</el-button>
                            <el-upload
                                    ref="upload6"
                                    style="display:inline-block;"
                                    action="/api/pc/examReport/update"
                                    :multiple="false"
                                    :data="{'id':scope.row.id,'version':scope.row.version}"
                                    :show-file-list="false"
                                    :auto-upload="false"
                                    :on-change="uploadChange"
                                    accept="image/jpeg,image/png,image/jpg,application/pdf"
                                    :on-success="uploadSuccess"
                                    :on-error="uploadError"
                            >
                                <el-button type="text" size="small">修改</el-button>
                            </el-upload>
                        </template>
                    </el-table-column>
                </el-table>
                <el-pagination
                        small
                        :page-size="5"
                        @current-change="handleCurrentChange3"
                        :current-page.sync="pageData.currentPage3"
                        layout="prev, pager, next"
                        :total="pageData.total3">
                </el-pagination>
            </el-card>

            <el-card class="examReportGetUnits">
                <div slot="header" class="clearfix">
                    <span>重点单位档案</span>
                    <div style="float:right;">
                        <el-upload
                                style="display:inline-block;"
                                action="/api/pc/examReport/addUnits"
                                :multiple="false"
                                :data="{'enterpriseid':enterprise.id}"
                                :show-file-list="false"
                                ref="upload7"
                                :auto-upload="false"
                                :on-change="uploadChange"
                                :on-success="uploadSuccess"
                                :on-error="uploadError"
                                accept="image/jpeg,image/png,image/jpg,application/pdf"
                        >
                            <el-button size="small" type="text">新增</el-button>
                        </el-upload>
                        <el-button type="text" size="small" @click="deleteReport(4)">删除</el-button>
                    </div>
                </div>
                <el-table
                        :data="examReportGetUnits"
                        @selection-change="handleSelectionChange4"
                        style="width: 100%">
                    <el-table-column
                            type="selection"
                            width="30">
                    </el-table-column>
                    <el-table-column
                            type="index"
                            label="序号"
                            width="50">
                    </el-table-column>
                    <el-table-column
                            prop="id"
                            label="报告ID"
                            width="200">
                    </el-table-column>
                    <el-table-column
                            prop="createdate"
                            label="创建日期"
                            width="200">
                    </el-table-column>
                    <!-- <el-table-column
                       prop="contentpic"
                       label="文件路径">
                     </el-table-column>-->
                    <el-table-column
                            label="操作">
                        <template slot-scope="scope">
                            <el-button type="text" size="small" @click="dialogfileView= true,dialogImageUrl='http://47.97.109.22/'+scope.row.contentpic">查看</el-button>
                            <el-upload
                                    ref="upload8"
                                    style="display:inline-block;"
                                    action="/api/pc/examReport/update"
                                    :multiple="false"
                                    :data="{'id':scope.row.id,'version':scope.row.version}"
                                    :show-file-list="false"
                                    :auto-upload="false"
                                    :on-change="uploadChange"
                                    accept="image/jpeg,image/png,image/jpg,application/pdf"
                                    :on-success="uploadSuccess"
                                    :on-error="uploadError"
                            >
                                <el-button type="text" size="small">修改</el-button>
                            </el-upload>
                        </template>
                    </el-table-column>
                </el-table>
                <el-pagination
                        small
                        :page-size="5"
                        @current-change="handleCurrentChange4"
                        :current-page.sync="pageData.currentPage4"
                        layout="prev, pager, next"
                        :total="pageData.total4">
                </el-pagination>
            </el-card>
        </el-dialog>
        <!-- 添加用户弹窗 -->
        <el-dialog
                top="8vh"
                title="添加用户"
                :visible.sync="dialogVisible"
                :close-on-press-escape="false"
                :close-on-click-modal="false"
                :show-close="false"
                @close="dialogFormVisibleClose">
            <el-form class="formData" ref="addForm" :model="itemData" :rules="rules" size="small">
                <el-form-item label="用户名称" prop="username">
                    <el-input v-model="itemData.username"></el-input>
                </el-form-item>
                <el-form-item label="账号"  prop="account">
                    <el-input v-model="itemData.account"></el-input>
                </el-form-item>
                <el-form-item label="密码"  prop="passwords">
                    <el-input v-model="itemData.passwords"></el-input>
                </el-form-item>
                <el-form-item label="电话号码"  prop="phone">
                    <el-input v-model="itemData.phone"></el-input>
                </el-form-item>
                <el-form-item label="地址"  prop="address">
                    <el-input v-model="itemData.address" type="textarea" :rows="2"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="dialogVisible = false">取 消</el-button>
                <el-button :loading="loading" type="primary" @click="saveNew">保 存</el-button>
            </div>
        </el-dialog>
        <!-- 修改档案弹窗    -->
        <el-dialog
                top="8vh"
                title="修改档案"
                :visible.sync="modifyEnterprise"
                :close-on-press-escape="false"
                :close-on-click-modal="false"
                :show-close="false"
                @close="modifyEnterpriseClose">
            <el-form class="formData" ref="modifyEnterpriseForm" :model="itemData" :rules="rules1" size="small">
                <el-form-item label="企业名称" prop="enterprisename">
                    <el-input v-model="itemData.enterprisename"></el-input>
                </el-form-item>
                <el-form-item label="企业联系人姓名"  prop="enterprisecontactname">
                    <el-input v-model="itemData.enterprisecontactname"></el-input>
                </el-form-item>
                <el-form-item label="企业联系人号码"  prop="enterprisecontactphone">
                    <el-input v-model="itemData.enterprisecontactphone"></el-input>
                </el-form-item>
                <el-form-item label="统一社会信用代码"  prop="unifiedsocialcreditcode">
                    <el-input v-model="itemData.unifiedsocialcreditcode"></el-input>
                </el-form-item>
                <el-form-item label="地址"  prop="address">
                    <el-input v-model="itemData.address" type="textarea" :rows="2"></el-input>
                </el-form-item>
                <el-form-item label="企业概述"  prop="enterpriseoverview">
                    <el-input v-model="itemData.enterpriseoverview" type="textarea" :rows="5"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="modifyEnterprise = false">取 消</el-button>
                <el-button :loading="loading" type="primary" @click="modifyEnterpriseList">保 存</el-button>
            </div>
        </el-dialog>
        <el-dialog :visible.sync="dialogfileView" top="5vh">
            <img width="100%" :src="dialogImageUrl" alt="">
        </el-dialog>
    </div>
</template>
<script>
    let _this = null;
    export default {
        data() {
            let validateUsername = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('用户名称不能为空'))
                }
                callback();
            };
            let validateAccount = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('账号不能为空'))
                }
                callback();
            };
            let validatePasswords = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('密码不能为空'))
                }
                callback();
            };
            let validatePhone = (rule, value, callback)=>{
                if(value){
                    if(!(/^1[34578]\d{9}$/.test(value))){
                        return callback(new Error('手机号码有误，请重填'));
                    }
                }
                callback();
            };
            let validateEnterprisename = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('企业名称不能为空'))
                }
                callback();
            };
            let validateEnterprisecontactname = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('企业联系人姓名不能为空'))
                }
                callback();
            };
            let validateEnterprisecontactphone = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('企业联系人号码不能为空'))
                }
                if(value){
                    if(!(/^1[34578]\d{9}$/.test(value))){
                        return callback(new Error('手机号码有误，请重填'));
                    }
                }
                callback();
            };
            let validateUnifiedsocialcreditcode = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('统一社会信用代码不能为空'))
                }
                callback();
            };
            let validateAddress = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('地址不能为空'))
                }
                callback();
            };
            let validateEnterpriseoverview = (rule, value, callback)=>{
                if(!value){
                    return callback(new Error('企业概述不能为空'))
                }
                callback();
            };
            return {
                //侧栏展开状态
                rightTabshow:true,
                //加载状态
                treeStatus:true,
                usersStatus:true,
                //树形数据
                treeData: [],
                //保存用户树形结构的展开状态
                treeExpandedArr: [],
                //树形配置
                treeOption:{
                    label:'rolename',
                    isLeaf:'leaf',
                },
                // 角色列表右键菜单
                menuVisible:false,
                //添加时候输入框绑定的角色名
                rolename:'',
                //存储角色节点中的节点和数据
                currentnode:'',
                currentdata:'',
                //添加状态
                addStatus:true,

                //下面用户数据
                usersData:[],
                //存储用户节点中的节点和数据
                userCurrentnode:'',
                userCurrentdata:'',
                //用户右键菜单显隐
                usersMenuVisible:false,
                //下面用户数据树形配置
                treeUsersOption:{
                    label:'username',
                    isLeaf:true,
                },
                //新增修改用户弹窗数据
                itemData:{},
                //添加用户弹窗显隐
                dialogVisible:false,
                loading:false,

                //查看档案弹窗
                dialogEnterprise:false,
                //档案数据
                enterprise:{},
                //工程师检查报告数据
                engineerChecksStatusReport:[],
                //电消检测报告数据
                reportElectricalEliminationTest:[],
                //风险评估报告数据
                riskAssessmentReport:[],
                //重点单位档案
                examReportGetUnits:[],
                //档案报告图片预览
                dialogfileView:false,
                //档案报告地址
                dialogImageUrl:'',
                //档案报告多选
                multipleSelection1: [],
                multipleSelection2: [],
                multipleSelection3: [],
                multipleSelection4: [],
                //档案分页数据,当前页,数据条数
                pageData:{
                    currentPage1:1,
                    total1:0,
                    currentPage2:1,
                    total2:0,
                    currentPage3:1,
                    total3:0,
                    currentPage4:1,
                    total4:0,
                },
                //修改档案弹窗
                modifyEnterprise:false,
                //校验规则
                rules:{
                    username:{ required:true,validator:validateUsername, trigger: 'blur' },
                    account:{ required:true,validator:validateAccount, trigger: 'blur' },
                    passwords:{ required:true,validator:validatePasswords, trigger: 'blur' },
                    phone:{validator:validatePhone, trigger: 'blur'},
                },
                //修改档案校验规则
                rules1:{
                    enterprisename:{ required:true,validator:validateEnterprisename, trigger: 'blur' },
                    enterprisecontactname:{ required:true,validator:validateEnterprisecontactname, trigger: 'blur' },
                    enterprisecontactphone:{ required:true,validator:validateEnterprisecontactphone, trigger: 'blur' },
                    unifiedsocialcreditcode:{ required:true,validator:validateUnifiedsocialcreditcode, trigger: 'blur' },
                    address:{ required:true,validator:validateAddress, trigger: 'blur' },
                    enterpriseoverview:{ required:true,validator:validateEnterpriseoverview, trigger: 'blur' },
                }
            };
        },
        mounted() {
            _this = this;
            this.getList();
        },
        methods: {
            //查询角色列表,页面首次加载调用这个fid = ""
            getList(){
                this.treeStatus = true;
                _this.$service.getList({
                    fid:'',
                    rolename:'',
                    currentPage:1,
                    pageSize:100,
                }).then(res=>{
                    if(res.data.state == "0"){
                        let dataList = res.data.list
                        //循环，给leaf赋值
                        for(let i=0;i<dataList.length;i++){
                            let leaf=dataList[i].lower === ("0" || null || undefined)?true:false;
                            dataList[i].leaf = leaf;
                        }
                        _this.treeData=dataList;
                        if(dataList.length === 0){
                            _this.treeStatus = false;
                            _this.$message.error('未能查询到您的角色！');
                        }else{
                            //设置默认最上级高亮默认显示
                            _this.$nextTick(() => {
                                _this.treeExpandedArr.push(this.treeData[0].id);
                                _this.$refs.tree.setCurrentKey(dataList[0].id);
                            });
                            //这里数据获得，那么把id传给左边的设备获取列表
                            _this.$emit('getId',dataList[0].id)
                            //设置currentdata
                            _this.currentdata = {}
                            _this.currentdata.id = dataList[0].id;
                            //把id传给用户列表获取数据
                            _this.getUsersList(dataList[0].id)
                        }
                    }else{
                        _this.$message.error(res.data.msg);
                    }
                })
            },
            //获取用户列表
            getUsersList(roleId){
                this.usersStatus = true;
                _this.$service.getUsersList({
                    roleId:roleId,
                    currentPage:1,
                    pageSize:100,
                }).then(res=>{
                    if(res.data.state == "0"){
                        _this.usersData = res.data.list;
                        if(res.data.list.length===0){
                            this.usersStatus = false;
                        }
                    }else{
                        _this.$message.error(res.data.msg);

                    }
                }).catch(es=>{

                })
            },
            //懒加载叶子节点
            loadNode(node,resolve){
                if(node.level == 0){
                    return resolve([]);
                }
                if(node.level > 0){
                    this.$service.getList({
                        fid:node.data.id,
                        currentPage:1,
                        pageSize:100
                    }).then(res=>{
                        if(res.data.state == "0"){
                            let dataList = res.data.list
                            //循环，给leaf赋值
                            for(let i=0;i<dataList.length;i++){
                                let leaf=dataList[i].lower === ("0" || null || undefined)?true:false;
                                dataList[i].leaf = leaf;
                            }
                            // debugger
                            return resolve(dataList)
                        }else{
                            _this.$message.error(res.data.msg);
                            return resolve([]);
                        }
                    })
                }
            },
            //角色列表菜单显示，定位菜单弹窗
            rightClick(event,object,node,self){
                if(object.id){
                    this.currentnode = node;
                    this.currentdata = object;
                    this.menuVisible = true;
                    let menu = this.$refs.menu;
                    menu.style.left = event.clientX-(document.body.clientWidth-250) + 'px';
                    menu.style.top = event.clientY-50 + 'px';
                }
            },
            //用户列表菜单显示，定位菜单弹窗
            usersRightClick(event,object,node,self){
                this.userCurrentnode = node;
                this.userCurrentdata = object;
                this.usersMenuVisible = true;
                let menu = this.$refs.usersMenu;
                menu.style.left = event.clientX-(document.body.clientWidth-250) + 'px';
                menu.style.top = event.clientY-50 + 'px';
            },
            //添加按钮
            onAdd(){
                //添加前输入框绑定值重置
                _this.rolename= "";
                let data = _this.currentdata;
                if(!data.children){
                    _this.$set(data,'children',[]);
                }
                //leaf为true表示为子节点，没有下级了，防止触发懒加载事件
                data.children.unshift({leaf:true,children:[]});
                //展开节点
                if(!_this.currentnode.expanded){
                    _this.currentnode.expanded = true;
                }
                //获取子节点数据
                _this.loadNode(_this.currentnode,function(res){

                });
                //点击添加的时候展开该节点
                _this.menuVisible = false;
            },
            //点击添加按钮后，输入内容回车触发
            addSubmit(data){
                if(this.rolename==""){
                    this.$message.warning('请输入角色名');
                }else{
                    this.$service.addRole({
                        fid:this.currentdata.id,
                        rolename:this.rolename
                    }).then(res=>{
                        if(res.data.state == "0"){
                            _this.$message.success("添加成功！");
                            //添加成功更新数据
                            // this.$set(data,'rolename',this.rolename);
                            //添加成功后要重新请求数据，防止再次新增无法获取父节点id
                            _this.cancelInput();//删除输入框
                            _this.loadNode(_this.currentnode,function(res){
                                debugger
                            })
                        }else{
                            _this.$message.error(res.data.msg);
                            _this.cancelInput();//删除输入框
                        }
                    }).catch(es=>{
                        _this.cancelInput();//删除输入框
                    })
                }
            },
            //取消输入
            cancelInput(){
                let node = this.currentnode;
                let data = this.currentdata;
                let children = node.childNodes
                let index = children.findIndex(d =>d.label == ("" || undefined));
                children.splice(index,1);
            },
            //取消输入和弹窗
            cancelAll(){
                this.menuVisible = false;
                this.usersMenuVisible = false;
            },
            //删除按钮
            onDelete(){
                let node = this.currentnode;
                let data = this.currentdata;
                this.menuVisible = false;
                this.$confirm('是否要删除角色'+ data.rolename +'？','提示',{
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    type: "warning"
                }).then(()=>{
                    let children = node.parent.data.children || node.parent.childNodes;
                    children.map((c,i)=>{
                        if(data.id == c.data.id){
                            _this.$service.deleteRole({
                                id:data.id
                            }).then(res=>{
                                if(res.data.state == "0"){
                                    children.splice(i,1);
                                    _this.$message.success('删除成功!');
                                }else{
                                    _this.$message.error(res.data.msg);
                                }
                            })
                        }
                    })
                })
                    .catch(()=>{return false;})

            },
            //点击角色项，设备列表随之改变，传递到left组件,下面的用户列表也改变
            toEquipment(object,Node,self){
                //判断有没有id，没有的话就是输入框,有的话就是服务器数据
                if(object.id){
                    this.currentnode = Node;
                    this.currentdata = object;
                    _this.getUsersList(object.id);
                    this.$emit('getId',object.id);
                }
            },
            //下面用户的处理逻辑
            //新增用户弹窗关闭
            dialogFormVisibleClose(){
                this.itemData = {};
                this.$refs.addForm.resetFields();
            },
            //新增用户弹窗保存
            saveNew(){
                this.$refs.addForm.validate(valid =>{
                    if(valid){
                        _this.loading = true,
                            this.itemData.roleId = this.currentdata.id
                        _this.$service.addUsers(this.itemData)
                            .then(res=>{
                                if(res.data.state == "0"){
                                    _this.$message.success('新增成功!');
                                    _this.dialogVisible = false;
                                    _this.loading = false;
                                    _this.getUsersList(this.currentdata.id);
                                }else{
                                    _this.loading = false;
                                    _this.$message.error(res.data.msg);
                                }
                            })
                            .catch(es=>{
                                _this.loading = false;
                            })
                    }
                })
            },
            //删除该用户
            userDelete(){
                _this.usersMenuVisible = false;
                this.$confirm('是否要删除用户'+ this.userCurrentdata.username +'？','提示',{
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    type: "warning"
                }).then(()=>{
                    _this.$service.deleteUsers({
                        ids:_this.userCurrentdata.id
                    })
                        .then(res=>{
                            if(res.data.state == "0"){
                                _this.$message.success('删除成功!');
                                _this.getUsersList(this.currentdata.id);
                            }else{
                                _this.$message.error(res.data.msg);
                            }
                        })
                }).catch(()=>{return fasle;})
            },
            //初始化当前选中的用户密码
            initPassword(){
                this.$confirm('是否初始化用户'+this.userCurrentdata.username+'的密码？','提示',{
                    confirmButtonText: "确认",
                    cancelButtonText: "取消",
                    type: "warning"
                })
                    .then(()=>{
                        _this.$service.initUsersPassword({
                            userId:_this.userCurrentdata.id
                        })
                            .then(res=>{
                                if(res.data.state == "0"){
                                    _this.$message.success('初始化密码成功!初始化后密码为123456');
                                    _this.usersMenuVisible = false;
                                }else{
                                    _this.$message.error(res.data.msg);
                                    _this.usersMenuVisible = false;
                                }
                            })
                            .catch(es=>{
                                _this.usersMenuVisible = false;
                            })
                    })
                    .catch(()=>{
                        return false;
                    })
            },
            /**
             * 角色档案
             * 相关逻辑
             */
            //查看用户档案弹窗关闭
            dialogEnterpriseClose(){
                this.enterprise = {};
            },
            //点击修改档案按钮
            modifyEnterpriseBtn(){
                this.itemData = Object.assign({},this.enterprise);
                this.modifyEnterprise = true;
            },
            //修改用户档案弹窗关闭
            modifyEnterpriseClose(){
                this.itemData = {};
                this.$refs.modifyEnterpriseForm.resetFields();
            },
            //获取角色档案，一个角色仅对应一条档案
            getEnterpriseList(){
                _this.$service.getEnterpriseList({
                    roleid:_this.currentdata.id,
                }).then(res=>{
                    if(res.data.state == "0"){
                        _this.enterprise = res.data.data;
                        _this.getEngineerChecksStatusReportList(res.data.data.id);
                        _this.getReportElectricalEliminationTestList(res.data.data.id);
                        _this.getRiskAssessmentReportList(res.data.data.id);
                        _this.getExamReportGetUnitsList(res.data.data.id);
                    }else{
                        _this.$message.error(res.data.msg);
                    }
                })
            },
            //修改角色档案
            modifyEnterpriseList(){
                this.$refs.modifyEnterpriseForm.validate(valid =>{
                    if(valid){
                        _this.loading = true;
                        _this.itemData.roleid = _this.currentdata.id;

                        _this.$service.modifyEnterpriseList(_this.itemData).then(res=>{
                            if(res.data.state == "0"){
                                _this.$message.success('修改成功!');
                                _this.modifyEnterprise = false;
                                _this.loading = false;
                                this.getEnterpriseList();
                            }else{
                                _this.loading = false;
                                _this.$message.error(res.data.msg);
                            }
                        }).catch(es=>{
                            _this.loading = false;
                        })
                    }
                })
            },
            //获取工程师检查情况报告
            getEngineerChecksStatusReportList(id){
                _this.$service.getEngineerChecksStatusReportList({
                    enterpriseid:id,
                    currentPage:_this.pageData.currentPage1,
                    pageSize:5,
                }).then(res=>{
                    if(res.data.state == "0"){
                        _this.engineerChecksStatusReport=res.data.list;
                        _this.pageData.total1 = res.data.data.total;
                    }else{
                        _this.$message.error(res.data.msg);
                    }
                })
            },
            //获取电消检测报告
            getReportElectricalEliminationTestList(id){
                _this.$service.getReportElectricalEliminationTestList({
                    enterpriseid:id,
                    currentPage:_this.pageData.currentPage2,
                    pageSize:5,
                }).then(res=>{
                    if(res.data.state == "0"){
                        _this.reportElectricalEliminationTest=res.data.list;
                        _this.pageData.total2 = res.data.data.total;
                    }else{
                        _this.$message.error(res.data.msg);
                    }
                })
            },
            //获取风险评估报告
            getRiskAssessmentReportList(id){
                _this.$service.getRiskAssessmentReportList({
                    enterpriseid:id,
                    currentPage:_this.pageData.currentPage3,
                    pageSize:5,
                }).then(res=>{
                    if(res.data.state == "0"){
                        _this.riskAssessmentReport=res.data.list;
                        _this.pageData.total3 = res.data.data.total;
                    }else{
                        _this.$message.error(res.data.msg);
                    }
                })
            },
            //获取重点单位档案
            getExamReportGetUnitsList(id){
                _this.$service.getExamReportGetUnitsList({
                    enterpriseid:id,
                    currentPage:_this.pageData.currentPage4,
                    pageSize:5,
                }).then(res=>{
                    if(res.data.state == "0"){
                        _this.examReportGetUnits=res.data.list;
                        _this.pageData.total4 = res.data.data.total;
                    }else{
                        _this.$message.error(res.data.msg);
                    }
                })
            },
            //档案分页处理
            handleCurrentChange1(val){
                this.pageData.currentPage1 = val;
                this.getEngineerChecksStatusReportList(_this.enterprise.id);
            },
            handleCurrentChange2(val){
                this.pageData.currentPage2 = val;
                this.getReportElectricalEliminationTestList(_this.enterprise.id);
            },
            handleCurrentChange3(val){
                this.pageData.currentPage3 = val;
                this.getRiskAssessmentReportList(_this.enterprise.id);
            },
            handleCurrentChange4(val){
                this.pageData.currentPage4 = val;
                this.getExamReportGetUnitsList(_this.enterprise.id);
            },
            //档案报告多选处理
            handleSelectionChange1(val) {
                this.multipleSelection1 = val;
            },
            handleSelectionChange2(val) {
                this.multipleSelection2 = val;
            },
            handleSelectionChange3(val) {
                this.multipleSelection3 = val;
            },
            handleSelectionChange4(val) {
                this.multipleSelection4 = val;
            },
            //删除报告
            deleteReport(type){
                if(type == 1){
                    if(this.multipleSelection1.length === 0){
                        this.$message.warning('请选择删除对象');
                    }else{
                        this.$confirm('确定删除'+this.multipleSelection1.length+'条记录？','提示',{
                            type:'info',
                        }).then(res=>{
                            let checkArr = this.multipleSelection1;
                            let ids = [] ;
                            let Tids = "";
                            checkArr.forEach(function(item){
                                ids.push(item.id)
                            })
                            Tids = ids.toString();
                            this.$service.deleteEngineerChecksStatusReport({
                                ids:Tids
                            }).then(res=>{
                                if(res.data.state == 0){
                                    this.$message.success('删除成功！');
                                    //处理当前页的数据全部删除
                                    if(this.multipleSelection1.length === _this.engineerChecksStatusReport.length && _this.pageData.currentPage1>1){
                                        _this.pageData.currentPage1--;
                                    }
                                    this.getEngineerChecksStatusReportList(_this.enterprise.id)
                                }else{
                                    this.$message.error(res.data.msg)
                                }
                            }).catch(es=>{})
                        })
                    }
                }
                if(type == 2){
                    if(this.multipleSelection2.length === 0){
                        this.$message.warning('请选择删除对象');
                    }else{
                        this.$confirm('确定删除'+this.multipleSelection2.length+'条记录？','提示',{
                            type:'info',
                        }).then(res=>{
                            let checkArr = this.multipleSelection2;
                            let ids = [] ;
                            let Tids = "";
                            checkArr.forEach(function(item){
                                ids.push(item.id)
                            })
                            Tids = ids.toString();
                            this.$service.deleteReportElectricalEliminationTest({
                                ids:Tids
                            }).then(res=>{
                                if(res.data.state == 0){
                                    this.$message.success('删除成功！');
                                    //处理当前页的数据全部删除
                                    if(this.multipleSelection2.length === _this.reportElectricalEliminationTest.length && _this.pageData.currentPage2>1){
                                        _this.pageData.currentPage2--;
                                    }
                                    this.getReportElectricalEliminationTestList(_this.enterprise.id)
                                }else{
                                    this.$message.error(res.data.msg)
                                }
                            }).catch(es=>{})
                        })
                    }
                }
                if(type == 3){
                    if(this.multipleSelection3.length === 0){
                        this.$message.warning('请选择删除对象');
                    }else{
                        this.$confirm('确定删除'+this.multipleSelection3.length+'条记录？','提示',{
                            type:'info',
                        }).then(res=>{
                            let checkArr = this.multipleSelection3;
                            let ids = [] ;
                            let Tids = "";
                            checkArr.forEach(function(item){
                                ids.push(item.id)
                            })
                            Tids = ids.toString();
                            this.$service.deleteRiskAssessmentReport({
                                ids:Tids
                            }).then(res=>{
                                if(res.data.state == 0){
                                    this.$message.success('删除成功！');
                                    //处理当前页的数据全部删除
                                    if(this.multipleSelection3.length === _this.riskAssessmentReport.length && _this.pageData.currentPage3>1){
                                        _this.pageData.currentPage3--;
                                    }
                                    this.getRiskAssessmentReportList(_this.enterprise.id)
                                }else{
                                    this.$message.error(res.data.msg)
                                }
                            }).catch(es=>{})
                        })
                    }
                }
                if(type == 4){
                    if(this.multipleSelection4.length === 0){
                        this.$message.warning('请选择删除对象');
                    }else{
                        this.$confirm('确定删除'+this.multipleSelection4.length+'条记录？','提示',{
                            type:'info',
                        }).then(res=>{
                            let checkArr = this.multipleSelection4;
                            let ids = [] ;
                            let Tids = "";
                            checkArr.forEach(function(item){
                                ids.push(item.id)
                            })
                            Tids = ids.toString();
                            this.$service.deleteRiskAssessmentReport({
                                ids:Tids
                            }).then(res=>{
                                if(res.data.state == 0){
                                    this.$message.success('删除成功！');
                                    //处理当前页的数据全部删除
                                    if(this.multipleSelection4.length === _this.examReportGetUnits.length && _this.pageData.currentPage4>1){
                                        _this.pageData.currentPage4--;
                                    }
                                    this.getExamReportGetUnitsList(_this.enterprise.id)
                                }else{
                                    this.$message.error(res.data.msg)
                                }
                            }).catch(es=>{})
                        })
                    }
                }
            },
            //报告新增修改文件改变
            uploadChange(file, fileList){
                if(fileList.length === 0){
                    return false;
                }
                if(fileList.length>1){
                    // this.$message.warning("只允许上传单个文件，第二次上传将会覆盖第一次");
                    fileList.splice(0,1);
                }
                if(file.response){
                    return false;
                }
                if(file.size/1024/1024>10){
                    this.$message.warning("上传失败，只允许上传小于10M的文件");
                    return false;
                }
                if(!new RegExp("(.jpeg)$|(.jpg)$|(.png)$|(.pdf)$").test(file.raw.type)){
                    this.$message.warning("文件格式只支持jpeg、jpg、png、pdf");
                    return false;
                }
                this.$confirm('确定上传文件名为'+file.name.split('.')[0]+'的文件吗？','提示',{
                    type:'info',
                }).then(()=>{
                    this.$nextTick(()=>{
                        file
                        this.$refs.upload1 && this.$refs.upload1.uploadFiles.length !==0?this.$refs.upload1.submit():'';
                        this.$refs.upload2 && this.$refs.upload2.uploadFiles.length !==0?this.$refs.upload2.submit():'';
                        this.$refs.upload3 && this.$refs.upload3.uploadFiles.length !==0?this.$refs.upload3.submit():'';
                        this.$refs.upload4 && this.$refs.upload4.uploadFiles.length !==0?this.$refs.upload4.submit():'';
                        this.$refs.upload5 && this.$refs.upload5.uploadFiles.length !==0?this.$refs.upload5.submit():'';
                        this.$refs.upload6 && this.$refs.upload6.uploadFiles.length !==0?this.$refs.upload6.submit():'';
                        this.$refs.upload7 && this.$refs.upload7.uploadFiles.length !==0?this.$refs.upload7.submit():'';
                        this.$refs.upload8 && this.$refs.upload8.uploadFiles.length !==0?this.$refs.upload8.submit():'';
                    })
                }).catch((res)=>{
                    this.$message.info('已取消操作');
                })
            },
            //报告新增上传成功
            uploadSuccess(response, file, fileList){
                if(response.state == 0){
                    this.$message.success('上传成功！');
                    // for(let key in file){
                    //   delete file[key];
                    // }
                    // fileList.splice(0,1);
                    this.getEngineerChecksStatusReportList(_this.enterprise.id);
                    this.getReportElectricalEliminationTestList(_this.enterprise.id);
                    this.getRiskAssessmentReportList(_this.enterprise.id);
                    this.getExamReportGetUnitsList(_this.enterprise.id);
                }else{
                    this.$message.error(response.msg);
                }
            },
            //报告新增上传失败
            uploadError(err, file, fileList){
                debugger
            },
        }
    };
</script>
<style lang="less" scoped>
    .rightbar {
        position: relative;
        transition: right 0.2s;
    .rightbar-wrap{
        width: 250px;
        height: calc(100vh - 50px);
        position: absolute;
        top: 0px;
        right: 0;
        background-color: rgba(0, 37, 53, 0.7);
        color: white;
        font-size: 12px;
        z-index: 1;
    p {
        line-height: 1;
        font-size: 18px;
        padding:0 18px 18px;
    }
    .tree-container{
        overflow: auto;
        height: calc(50vh - 80px);
        width:250px;
    .el-tree {
        background: none;
        color: white;
    .custom-tree-node{
    img,span{
        vertical-align: middle;
    }
    span{
        padding-right: 18px;
    }
    }
    }
    }
    .rightbar-top,.rightbar-bottom{
        height: calc(50% - 18px);
        width: 250px;
        margin-top: 18px;
    .menu{
        min-width:80px;
        position: absolute;
        border-radius: 10px;
        border:1px solid #0a5357;
        color:white;
        overflow: hidden;
        background-color: rgba(0, 37, 53, 0.7);
    .menu__item{
        white-space: nowrap;
        display: block;
        padding: 10px;
    &:hover{
         background-color: #0a5357;
         color:white;
     }
    i{
        margin-right: 6px;
    }
    }
    }
    }
    // .rightbar-top{

       // }
    .rightbar-bottom{
    .rightbar-bottom-title{
        font-size:18px;
        padding: 0 18px 18px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    div{
        cursor: pointer;
        font-size: 12px !important;
    &:hover{
         color:#2df5c7;
     }
    }
    }
    }
    .right-toggle{
        background: white;
        height: 50px;
        width: 10px;
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
    }
    }
    }
</style>
<style lang="less">
    .rightbar {
    .el-tree-node:focus>.el-tree-node__content,.el-tree-node__content:hover{
        background-color:rgba(2,33,46,1);
    }
    .tree-input{
        width:100px;
    .el-input__inner{
        height: auto;
        padding:0;
        line-height: 1;
    &::-webkit-input-placeholder{
         font-size:12px;
     }
    &::-moz-placeholder{
         font-size:12px;
     }
    &::-ms-input-placeholder{
         font-size:12px;
     }
    }
    }
    .el-tree--highlight-current .el-tree-node.is-current>.el-tree-node__content{
        background-color:#02212e;
    }
    .dialogEnterprise{
    .el-dialog{
        margin: 10vh auto 0 !important;
        height: 700px;
        max-height:75vh;
        width:750px;
    .el-dialog__body{
        overflow: auto;
        height: calc(700px - 54px);
        max-height:calc(75vh - 54px);
    }
    .el-card{
        margin-bottom:20px;
    .el-pagination{
        text-align:center;
        margin-top:10px;
    }
    }
    .enterprise{
        line-height:30px;
    span{
        width:49%;
        display: inline-block;
    }
    }
    }
    }
    }
</style>
